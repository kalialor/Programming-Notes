"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("three"),r=require("react"),t=require("@react-three/fiber"),i=require("./AxisArrow.cjs.js"),o=require("./PlaneSlider.cjs.js"),a=require("./AxisRotator.cjs.js"),n=require("./context.cjs.js");function c(e){if(e&&e.__esModule)return e;var r=Object.create(null);return e&&Object.keys(e).forEach((function(t){if("default"!==t){var i=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,i.get?i:{enumerable:!0,get:function(){return e[t]}})}})),r.default=e,Object.freeze(r)}require("../../core/Line.cjs.js"),require("@babel/runtime/helpers/extends"),require("three-stdlib"),require("../Html.cjs.js"),require("react-dom/client"),require("lodash.clamp");var s=c(e),l=c(r);const u=new s.Vector3,d=new s.Vector3,p=new s.Vector3,x=(e,r,t,i=1)=>{const o=u.set(e.x/t.width*2-1,-e.y/t.height*2+1,i);return o.unproject(r),o},m=(e,r,t,i)=>{const o=((e,r,t)=>{const i=t.width/2,o=t.height/2;r.updateMatrixWorld(!1);const a=e.project(r);return a.x=a.x*i+i,a.y=-a.y*o+o,a})(p.copy(e),t,i);let a=0;for(let n=0;n<2;++n){const c=d.copy(o).setComponent(n,o.getComponent(n)+r),s=x(c,t,i,c.z);a=Math.max(a,e.distanceTo(s))}return a},y=new s.Matrix4,f=new s.Matrix4,w=new s.Matrix4,g=new s.Matrix4,v=new s.Matrix4,h=new s.Matrix4,j=new s.Matrix4,b=new s.Matrix4,E=new s.Box3,A=new s.Box3,M=new s.Vector3,V=new s.Vector3,q=new s.Vector3,R=new s.Vector3,S=new s.Vector3(1,0,0),P=new s.Vector3(0,1,0),C=new s.Vector3(0,0,1),D=l.forwardRef((({matrix:e,onDragStart:r,onDrag:c,onDragEnd:u,autoTransform:d=!0,anchor:p,disableAxes:x=!1,disableSliders:D=!1,disableRotations:W=!1,activeAxes:O=[!0,!0,!0],offset:B=[0,0,0],rotation:L=[0,0,0],scale:T=1,lineWidth:z=4,fixed:_=!1,translationLimits:k,rotationLimits:F,depthTest:H=!0,axisColors:I=["#ff2060","#20df80","#2080ff"],hoveredColor:U="#ffff40",displayValues:G=!0,annotationsClass:J,opacity:K=1,visible:N=!0,userData:Q,children:X},Y)=>{const Z=t.useThree((e=>e.invalidate)),$=l.useRef(null),ee=l.useRef(null),re=l.useRef(null),te=l.useRef(null),ie=l.useRef([0,0,0]);l.useLayoutEffect((()=>{p&&(te.current.updateWorldMatrix(!0,!0),g.copy(te.current.matrixWorld).invert(),E.makeEmpty(),te.current.traverse((e=>{e.geometry&&(e.geometry.boundingBox||e.geometry.computeBoundingBox(),h.copy(e.matrixWorld).premultiply(g),A.copy(e.geometry.boundingBox),A.applyMatrix4(h),E.union(A))})),M.copy(E.max).add(E.min).multiplyScalar(.5),V.copy(E.max).sub(E.min).multiplyScalar(.5),q.copy(V).multiply(new s.Vector3(...p)).add(M),R.set(...B).add(q),re.current.position.copy(R),Z())}));const oe=l.useMemo((()=>({onDragStart:e=>{y.copy(ee.current.matrix),f.copy(ee.current.matrixWorld),r&&r(e),Z()},onDrag:e=>{w.copy($.current.matrixWorld),g.copy(w).invert(),v.copy(f).premultiply(e),h.copy(v).premultiply(g),j.copy(y).invert(),b.copy(h).multiply(j),d&&ee.current.matrix.copy(h),c&&c(h,b,v,e),Z()},onDragEnd:()=>{u&&u(),Z()},translation:ie,translationLimits:k,rotationLimits:F,axisColors:I,hoveredColor:U,opacity:K,scale:T,lineWidth:z,fixed:_,displayValues:G,depthTest:H,userData:Q,annotationsClass:J})),[r,c,u,ie,k,F,H,T,z,_,...I,U,K,G,Q,d,J]),ae=new s.Vector3;return t.useFrame((e=>{if(_){const o=m(re.current.getWorldPosition(ae),T,e.camera,e.size);var r,t,i;if(re.current)(null==(r=re.current)?void 0:r.scale.x)===o&&(null==(t=re.current)?void 0:t.scale.y)===o&&(null==(i=re.current)?void 0:i.scale.z)===o||(re.current.scale.setScalar(o),e.invalidate())}})),l.useImperativeHandle(Y,(()=>ee.current),[]),l.createElement(n.context.Provider,{value:oe},l.createElement("group",{ref:$},l.createElement("group",{ref:ee,matrix:e,matrixAutoUpdate:!1},l.createElement("group",{visible:N,ref:re,position:B,rotation:L},!x&&O[0]&&l.createElement(i.AxisArrow,{axis:0,direction:S}),!x&&O[1]&&l.createElement(i.AxisArrow,{axis:1,direction:P}),!x&&O[2]&&l.createElement(i.AxisArrow,{axis:2,direction:C}),!D&&O[0]&&O[1]&&l.createElement(o.PlaneSlider,{axis:2,dir1:S,dir2:P}),!D&&O[0]&&O[2]&&l.createElement(o.PlaneSlider,{axis:1,dir1:C,dir2:S}),!D&&O[2]&&O[1]&&l.createElement(o.PlaneSlider,{axis:0,dir1:P,dir2:C}),!W&&O[0]&&O[1]&&l.createElement(a.AxisRotator,{axis:2,dir1:S,dir2:P}),!W&&O[0]&&O[2]&&l.createElement(a.AxisRotator,{axis:1,dir1:C,dir2:S}),!W&&O[2]&&O[1]&&l.createElement(a.AxisRotator,{axis:0,dir1:P,dir2:C})),l.createElement("group",{ref:te},X))))}));exports.PivotControls=D,exports.calculateScaleFactor=m;
